# IF-CRITIC: Towards a Fine-Grained LLM Critic for Instruction-Following Evaluation

This repository is the official implementation of [IF-CRITIC: Towards a Fine-Grained LLM Critic for Instruction-Following Evaluation](https://arxiv.org/abs/2511.01014). 

IF-CRITIC is an open-sourced LLM critic designed to deliver fine-grained assessments for instruction-following. The scalable reward signals provided by IF-CRITIC can bring substantial performance gains to LLMs in instruction-following optimization under low computational overhead.

## ‚öôÔ∏è Requirements

To install requirements:

```shell
pip install -r requirements.txt
```

## üî• IF-CRITIC Training

- Our training codes of SFT and DPO are based on [LLama-Factory](https://github.com/hiyouga/LLaMA-Factory).
- We provide the prompt templates applied in critique training data construction in ```if_critic_training/prompts```.
- We provide some examples of training data during SFT and DPO, along with corresponding precess codes in ```if_critic_training/sft/``` and ```if_critic_training/dpo/```. Specifically:
  - ```*_data_examples.json``` is the raw training data.
  - ```*_training_data_llamafactory``` is the precessed training data which can be directly used in Llama-Factory framework.

## üöÄ IF-CRITIC Usage

The usage of IF-CRITIC comprises two key steps: 

- Decomposing the instruction to generate a constraint checklist.
- Generating critiques that evaluate the following of each constraint in the checklist. 

Our implementation is based on [vllm](https://github.com/vllm-project/vllm) framework. 

### Step 1: Checklist Generation

Some examples of input instructions are placed in `checklist_generation/input_examples.json`. You could preprocess your own instructions referring to these files. 

The format of a input instruction is as follows:

- `instruction` (string): The input instruction.

Run this command to generate constraint checklists for the input instructions:

```shell
cd checklist_generation
python checklist_generator_inference.py \
    --model_path <path_to_the_checklist_generator> \
    --input_path <path_to_the_input_instructions> \
    --output_path <path_to_results_file>
```

The `checklist` field is the constraint checklist generated by our checklist generator, and the `checklist_struct` field is the result of parsing `checklist` into a structured format.

### Step 2: Critique Generation

Some examples of evaluation inputs are placed in `critique_generation/input_examples.json`. You could preprocess your own evaluation inputs referring to these files. 

The format of a evaluation input is as follows:

- `instruction` (string): The input instruction.
- `response` (string): The response for the instruction.
- `checklist` (string): The constraint checklist for the instruction.

Run this command to generate critiques for the evaluation inputs:

```shell
cd critique_generation
python if_critic_inference.py \
    --model_path <path_to_IF_CRITIC> \
    --input_path <path_to_the_evaluation_inputs> \
    --output_path <path_to_results_file>
```

The `critique` field is the critique for the evaluation input generated by IF-CRITIC, and the `critique_struct` field is the result of parsing `critique` into a structured format.

## üìç Instruction-Following Optimization

- Our training codes of DPO are based on [LLama-Factory](https://github.com/hiyouga/LLaMA-Factory).

- Our training codes of GRPO are modified from [VeRL](https://github.com/volcengine/verl). We provide our codes in ```instruction_following_optimization/verl```.  Specifically:

  - We provide some examples of training instructions in ```instruction_following_optimization/verl/data/instruction_optimization/data_examples.json```. You should generate constraint checklists for these instructions first. To prepare this data for GRPO training, run this command:

    ```shell
    cd instruction_following_optimization/verl/examples/data_preprocess
    python if_prompts.py
    ```

  - The scripts of GRPO training are provided in ```instruction_following_optimization/verl/scripts```.

  - The reward calculation for IF-CRITIC is implemented in ```instruction_following_optimization/verl/verl/utils/reward_score/remote_if_critic.py```. You need to deploy IF-CRITIC through vllm framework and replace the url in Line 106.

### Citation

```
@article{wen2025if,
  title={IF-CRITIC: Towards a Fine-Grained LLM Critic for Instruction-Following Evaluation},
  author={Wen, Bosi and Niu, Yilin and Wang, Cunxiang and Ke, Pei and Ling, Xiaoying and Zhang, Ying and Zeng, Aohan and Wang, Hongning and Huang, Minlie},
  journal={arXiv preprint arXiv:2511.01014},
  year={2025}
}
```

Please kindly cite our paper if this paper and the codes are helpful.